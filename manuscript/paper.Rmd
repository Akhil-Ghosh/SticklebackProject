---
title: |
  |  \Large Stickle!
author: | 
  | \large Matthew Stuart \vspace{-1.1mm}
  | \normalsize Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`mstuart1@luc.edu`](mailto:mstuart1@luc.edu) \vspace{-1.1mm}
  |
  | \large Akhil Ghosh \vspace{-1.1mm}
  | \normalsize Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`aghosh@luc.edu`](mailto:aghosh@luc.edu) \vspace{-1.1mm}
  |
  | \large Yoel E. Stuart \vspace{-1.1mm}
  | \normalsize Department of Biology \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`ystuart@luc.edu`](mailto:ystuart@luc.edu) \vspace{-1.1mm}
  |
  | \large Gregory J. Matthews \vspace{-1.1mm}
  | \normalsize Center for Data Science and Consulting; Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`gmatthews1@luc.edu`](mailto:gmatthews1@luc.edu) \vspace{-1.1mm}
abstract: |
  | Evewryone loves the stickle \vspace{2mm}
  | *Keywords*: Stickle
bibliography: references.bib
fontsize: 12pt
link-citations: true
linkcolor: cyan
urlcolor: cyan
output:
  pdf_document:
    df_print: kable
    number_sections: true
    keep_tex: true
header-includes:
 \usepackage{setspace}
 \setstretch{1.15}
 \usepackage{float}
 \floatplacement{figure}{t}
---

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE
)

gjm <- function(x, color = "red") {
  sprintf("\\textcolor{%s}{%s}", color, x)}
```

\newcommand{\iid}{\overset{iid}{\sim}}

```{r pkgs}
library(tidyverse)
theme_set(theme_minimal())
library(Lahman)
```

\newpage

# Introduction {#sec:intro}
Sexual Dimorphism is interesting because...... 

Sexual Dimoprhism lit review:
@SaittaEtAl2020 

Studying sexual dimorphism of phenotypes in modern species is a straightforward endeavor: measure a phenotype of interest and statistically test for differences between the sexes.  However, examining sexual dimorphism in fossils is complicated substantially by the issue that sex may not be able to be directly observed from fossil specimens.  For this study, we have two sources of data: 1) Modern stickleback specimens with observed sex and 2) fossil specimens with sex unobserved.  We view the sex of the fossils as missing data and use multiple imputation (@little2002statistical) to impute the sex of the fossils using the modern stickleback fish with observed sex to model the relationship between sex and observed phenotypes.  Once sex is imputed, an Ornsteinâ€“Uhlenbeck (OU) model is fit using a Bayesian framework to look for sexual dimorphism across a variety of stickleback phenotypes (e.g. length, vertebrae count?, etc).

The remainder of this manuscript contains a description of the data in section \ref{sec:data} and a description of our models in \ref{sec:models}. Section \ref{sec:results} presents a summary of our results, and we end with our conclusion and future work in section \ref{sec:conclusions}.  

# Data {#sec:data}

```{r}
stickle <- read_csv('stickle_revamped.csv')

stick <- stickle %>% 
  mutate(gender = as.factor(case_when(
    grepl(".M.",univID,fixed=TRUE) ~ "Male",
    grepl(".F.",univID,fixed=TRUE) ~ "Female",
    grepl("Fos",univID,fixed=TRUE) ~ NA_character_
    )), ips = as.factor(ips)
  ) %>% 
  select(gender, everything())

#getting time vector, adding it to imputed data
univ <- stick %>% 
  mutate(time = as.integer(sub(".*([0-9]{2})\\..*", "\\1",univID)))
times <- univ %>% drop_na(time) %>% pull(time)

times_vector <- c(rep(1,43)) %>% 
  append(21-times)

#fossil n
fortab <- data.frame(time = 1:18, count = as.character(as.numeric((table(times_vector)))))
#knitr::kable(fortab)
#print(xtable(fortab),include.rownames = FALSE)
```

The data used here consists of a total of `r sum(!is.na(stick$gender))` extant specimens with known sex all collected in the last 30 years.  Of these, there are `r sum(stick$gender == "Female",na.rm = TRUE)` and `r sum(stick$gender == "Male",na.rm = TRUE)` female and male specimens, respectively.  

In addition there are `r sum(is.na(stick$gender))` fossil specimens from approximately 10.3 million years ago with unknown sex over 18 time periods spaced about 1000 years apart. Table 1 shows the sample size at each of the 18 time periods.  There are at least 22 specimens at each time period with a high of 67 specimens in period 7.  


<!-- % latex table generated in R 4.2.2 by xtable 1.8-4 package -->
<!-- % Mon May  1 11:20:28 2023 -->
\begin{table}[ht]
\centering
\begin{tabular}{rl}
  \hline
time & count \\ 
  \hline
  1 & 43 \\ 
    2 & 41 \\ 
    3 & 51 \\ 
    4 & 41 \\ 
    5 & 46 \\ 
    6 & 48 \\ 
    7 & 67 \\ 
    8 & 55 \\ 
    9 & 42 \\ 
   10 & 33 \\ 
   11 & 37 \\ 
   12 & 22 \\ 
   13 & 41 \\ 
   14 & 43 \\ 
   15 & 46 \\ 
   16 & 47 \\ 
   17 & 56 \\ 
   18 & 55 \\ 
   \hline
\end{tabular}
\label{tab1}
\caption{The number of stickleback fossils at each time point.  Sample size at each time point ranges from a low of 22 to a high of 67.}
\end{table}

What covariates do we have in the data: length, what else, 


# Models  {#sec:models}
## Imputation Model 
Let $\boldsymbol{W}$ be an $(n_{extant} + n_{fossil}) \times 1$ vector of the covariate gender of the stickleback fish, $\boldsymbol{X}$ be an $(n_{extant} + n_{fossil}) \times K$ matrix of the $K$ continuous phenotypes of interest, and $\boldsymbol{Y}$ be an $(n_{extant} + n_{fossil}) \times L$ matrix of the $L$ discrete phenotypes of interest.  Because the gender of the fossilized stickleback fish is unobservable, we further define $\boldsymbol{W} = (\boldsymbol{W}_{extant}^T,\boldsymbol{W}_{fossil}^T)^T$ where $\boldsymbol{W}_{extant}$ and $\boldsymbol{W}_{fossil}$ are the $n_{extant} \times 1$ and $n_{fossil} \times 1$ vectors of the observed extant gender and missing fossil gender, respectively.

We impute the missing gender for the fossil data by sampling from the posterior predictive distribution $P(\boldsymbol{W}_{fossil}|\boldsymbol{W}_{extant}, \boldsymbol{X}, \boldsymbol{Y})$ using the multiple imputation with chained equations (MICE) algorithm (@MICE) with predictive mean matching.  The imputation algorithm is run to obtain a total of $M = 100$ completed datasets.

## Completed Data Model 
For a given imputed dataset, let $W_{ti}$ be the imputed gender, $\boldsymbol{X}_{ti}$ be the $K \times 1$ vector of continuous phenotypes, and $\boldsymbol{Y}_{ti}$ be the $L \times 1$ vector of discrete phenotypes for $t = 1, \ldots, T$ and  $i = 1\ldots,n_{t}$).

Define the last element of $\boldsymbol{X}_{ti}$ ($X_{K,ti}$) as the length of the stickleback.  For $k = 1,\cdots,K - 1$, we will assume
\begin{align}
{X}_{k,ti} & \iid \left\{\begin{array}{llll} \mathcal{N}(\mu_{k,ft} & + \beta_k(X_{K,ti} - \mu_{K,ft}),&\sigma_k^2), & W_{ti} = \text{Female} \\ \mathcal{N}(\mu_{k,mt} & + \beta_k(X_{K,ti} - \mu_{K,mt}),&\sigma_k^2), & W_{ti} = \text{Male} \end{array}\right. \\
{X}_{K,ti} & \iid \left\{\begin{array}{lll} \mathcal{N}(\mu_{K,ft},&\sigma_{K}^2), & W_{ti} = \text{Female} \\ \mathcal{N}(\mu_{K,mt},&\sigma_{K}^2), & W_{ti} = \text{Male} \end{array}\right.
\label{eq:X}
\end{align}
where $\mu_{k,ft}$ and $\mu_{k,mt}$ represent the time-$t$ specific mean of phenotype $k$ for female and male stickleback fish, respectively, and $\beta_k$ is an additional parameter to account for the biological phenomenon that other continuous phenotypes for a particular animal are positively correlated with their length \textbf{CITATION NEEDED}.  We further set \begin{align}
\mu_{k,gt} = \theta_{k,g} + u_{k,gt},
\label{eq:mu}
\end{align}
for $g \in \{f,m\}$ where $\theta_{k,g}$ is the overall mean of phenotype $X_k$ for each gender, and $u_{k,gt}$ measures the difference between $\mu_{k,gt}$ and $\theta_{k,g}$.  We then fit $\boldsymbol{u}_{k,g} = \{u_{k,g1},\cdots,u_{k,gT}\}$ to an Ornstein-Uhlenback (OU) process (@OUprocess) where we assume $u_{k,gT}$ have a marginal mean of 0. Because each time period is ~1000 years, we will discretize the OU process without loss of generality.  For $t = 2,\ldots,T$, we assume
\begin{align}
u_{k,gt} \iid \mathcal{N}(\kappa_{k} u_{k,g(t-1)} , \tau_k^2).
\label{eq:u_ar1}
\end{align}

$\kappa_{k,g}$ represents the correlation between $\mu_{k,gt}$ and $\mu_{k,g(t+1)}$, and it also follows that $\text{cor}(u_{g,t},u_{g,t+h}) = \kappa^h$ for $h \in \mathbb{N}$.  In addition, we assume
\begin{align}
u_{k,g1} \iid \mathcal{N}\left(0,\frac{\tau_k^2}{1-\kappa_{k}^2}\right).
\label{eq:u1}
\end{align}
This model choice is to preserve stationarity; i.e. $p(u_{k,gs}) = p(u_{k,gt})$ for $s \neq t$.

For the discrete phenotypes, we will assume
\begin{align}
{Y}_{l,ti} & \sim \left\{\begin{array}{ll} Poisson(\lambda_{l,ft}), & W_{ti} = \text{Female} \\ Poisson(\lambda_{l,mt}), & W_{ti} = \text{Male} \end{array}\right.,
\label{eq:Y}
\end{align}
for $l = 1,\cdots,L$.  Similar to the continuous phenotypes, we set
\begin{align}
\log(\lambda_{l,gt}) = \gamma_{l,g} + v_{l,gt}.
\label{eq:lambda}
\end{align}
We use the log function to allow $v_{l,gt}$ to take all values on the real number line so we can properly fit an OU process to these effects.  We further assume
\begin{align}
v_{l,gt} \iid \mathcal{N}(\phi_{l} v_{l,g(t-1)} , \omega_l^2),
\label{eq:v_ar1}
\end{align}
and
\begin{align}
v_{l,g1} \iid \mathcal{N}\left(0,\frac{\omega_l^2}{1 - \phi_{l}^2}\right)..
\label{eq:v1}
\end{align}

Because we are fitting a dataset with a stochastic structure on the means of the phenotypes, we analyze the data via a Bayesian analysis.  Bayesian data analysis is also more naturally used when we have to impute data (\textbf{CITATION}).

Priors: For $k = 1,\cdots,K$ and $l = 1,\cdots,L$, 

\begin{align}
\sigma_k & \iid \mathcal{N}(0,100)I_{\{\sigma > 0\}} \nonumber \\
\tau_k & \iid \mathcal{N}(0,100)I_{\{\tau > 0\}} \nonumber \\
\kappa_k & \iid \mathcal{N}(0,1)I_{\{-1 < \kappa_g < 1\}} \nonumber \\
\beta_k & \iid \mathcal{N}(0,5) \\
\theta_{k,g} & \iid \mathcal{N}(0,10000)
\omega_l & \iid \mathcal{N}(0,100)I_{\{\tau > 0\}} \nonumber \\
\phi_l & \iid \mathcal{N}(0,1)I_{\{-1 < \kappa_g < 1\}} \nonumber \\
\gamma_{l,g} & \iid \mathcal{N}(0,10000)
\label{eq:priors}
\end{align}


All models were built using @R2022language

@Cornault2022 Bayesian OU model.  

Bayesian Analysis after multiple imputation @ZhouReiter2009: They recommend using a large number of imputations.  5 or 10 is too small.  We are using M = 100.  


# Results {#sec:results}

# Future work and conclusions {#sec:conclusions}


# Acknowledgements {-}


Stickle!

# Supplementary Material {-}

All code for reproducing the analyses in this paper is publicly available at https://github.com/Akhil-Ghosh/SticklebackProject

# References
