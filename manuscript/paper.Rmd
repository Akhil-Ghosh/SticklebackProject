---
title: |
  |  \Large Stickle!
author: | 
  | \large Matthew Stuart \vspace{-1.1mm}
  | \normalsize Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`mstuart1@luc.edu`](mailto:mstuart1@luc.edu) \vspace{-1.1mm}
  |
  | \large Akhil Ghosh \vspace{-1.1mm}
  | \normalsize Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`aghosh@luc.edu`](mailto:aghosh@luc.edu) \vspace{-1.1mm}
  |
  | \large Yoel E. Stuart \vspace{-1.1mm}
  | \normalsize Department of Biology \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`ystuart@luc.edu`](mailto:ystuart@luc.edu) \vspace{-1.1mm}
  |
  | \large Gregory J. Matthews \vspace{-1.1mm}
  | \normalsize Center for Data Science and Consulting; Department of Mathematics and Statistics \vspace{-1.1mm}
  | \normalsize Loyola University Chicago \vspace{-1.1mm}
  | \normalsize Chicago, IL 60660 \vspace{-1.1mm}
  | \normalsize [`gmatthews1@luc.edu`](mailto:gmatthews1@luc.edu) \vspace{-1.1mm}
abstract: |
  | Evewryone loves the stickle \vspace{2mm}
  | *Keywords*: Stickle
bibliography: references.bib
fontsize: 12pt
link-citations: true
linkcolor: cyan
urlcolor: cyan
output:
  pdf_document:
    df_print: kable
    number_sections: true
    keep_tex: true
header-includes:
 \usepackage{setspace}
 \setstretch{1.15}
 \usepackage{float}
 \floatplacement{figure}{t}
---

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE
)

gjm <- function(x, color = "red") {
  sprintf("\\textcolor{%s}{%s}", color, x)}
```

\newcommand{\iid}{\overset{iid}{\sim}}

```{r pkgs}
library(tidyverse)
theme_set(theme_minimal())
library(Lahman)
```

\newpage

# Introduction {#sec:intro}
Sexual Dimorphism is interesting because...... 

Sexual Dimoprhism lit review:
@SaittaEtAl2020 

Studying sexual dimorphism of phenotypes in modern species is a straightforward endeavor: measure a phenotype of interest and statistically test for differences between the sexes.  However, examining sexual dimorphism in fossils is complicated substantially by the issue that sex may not be able to be directly observed from fossil specimens.  For this study, we have two sources of data: 1) Modern stickleback specimens with observed sex and 2) fossil specimens with sex unobserved.  We view the sex of the fossils as missing data and use multiple imputation (@little2002statistical) to impute the sex of the fossils using the modern stickleback fish with observed sex to model the relationship between sex and observed phenotypes.  Once sex is imputed, an Ornsteinâ€“Uhlenbeck (OU) model is fit using a Bayesian framework to look for sexual dimorphism across a variety of stickleback phenotypes (e.g. length, vertebrae count?, etc).

The remainder of this manuscript contains a description of the data in section \ref{sec:data} and a description of our models in \ref{sec:models}. Section \ref{sec:results} presents a summary of our results, and we end with our conclusion and future work in section \ref{sec:conclusions}.  

# Data {#sec:data}

```{r}
stickle <- read_csv('stickle_revamped.csv')

stick <- stickle %>% 
  mutate(gender = as.factor(case_when(
    grepl(".M.",univID,fixed=TRUE) ~ "Male",
    grepl(".F.",univID,fixed=TRUE) ~ "Female",
    grepl("Fos",univID,fixed=TRUE) ~ NA_character_
    )), ips = as.factor(ips)
  ) %>% 
  select(gender, everything())

#getting time vector, adding it to imputed data
univ <- stick %>% 
  mutate(time = as.integer(sub(".*([0-9]{2})\\..*", "\\1",univID)))
times <- univ %>% drop_na(time) %>% pull(time)

times_vector <- c(rep(1,43)) %>% 
  append(21-times)

#fossil n
fortab <- data.frame(time = 1:18, count = as.character(as.numeric((table(times_vector)))))
#knitr::kable(fortab)
#print(xtable(fortab),include.rownames = FALSE)
```

The data used here consists of a total of `r sum(!is.na(stick$gender))` extant specimens with known sex all collected in the last 30 years.  Of these, there are `r sum(stick$gender == "Female",na.rm = TRUE)` and `r sum(stick$gender == "Male",na.rm = TRUE)` female and male specimens, respectively.  

In addition there are `r sum(is.na(stick$gender))` fossil specimens from approximately 10.3 million years ago with unknown sex over 18 time periods spaced about 1000 years apart. Table 1 shows the sample size at each of the 18 time periods.  There are at least 22 specimens at each time period with a high of 67 specimens in period 7.  


<!-- % latex table generated in R 4.2.2 by xtable 1.8-4 package -->
<!-- % Mon May  1 11:20:28 2023 -->
\begin{table}[ht]
\centering
\begin{tabular}{rl}
  \hline
time & count \\ 
  \hline
  1 & 43 \\ 
    2 & 41 \\ 
    3 & 51 \\ 
    4 & 41 \\ 
    5 & 46 \\ 
    6 & 48 \\ 
    7 & 67 \\ 
    8 & 55 \\ 
    9 & 42 \\ 
   10 & 33 \\ 
   11 & 37 \\ 
   12 & 22 \\ 
   13 & 41 \\ 
   14 & 43 \\ 
   15 & 46 \\ 
   16 & 47 \\ 
   17 & 56 \\ 
   18 & 55 \\ 
   \hline
\end{tabular}
\label{tab1}
\caption{The number of stickleback fossils at each time point.  Sample size at each time point ranges from a low of 22 to a high of 67.}
\end{table}

What covariates do we have in the data: length, what else, 


# Models  {#sec:models}
## Imputation Model 
Let $\boldsymbol{W}$ be an $(n_{extant} + n_{fossil}) \times 1$ vector of the covariate gender of the stickleback fish, $\boldsymbol{X}$ be an $(n_{extant} + n_{fossil}) \times K_{cont}$ matrix of the $K_{cont}$ continuous phenotypes of interest, and $\boldsymbol{Y}$ be an $(n_{extant} + n_{fossil}) \times K_{disc}$ matrix of the $K_{disc}$ discrete phenotypes of interest.  Because the gender of the fossilized stickleback fish is unobservable, we further define $\boldsymbol{W} = (\boldsymbol{W}_{extant}^T,\boldsymbol{W}_{fossil}^T)^T$ where $\boldsymbol{W}_{extant}$ and $\boldsymbol{W}_{fossil}$ are the $n_{extant} \times 1$ and $n_{fossil} \times 1$ vectors of the observed extant gender and missing fossil gender, respectively.

We impute the missing gender for the fossil data by sampling from the posterior predictive distribution $P(\boldsymbol{W}_{fossil}|\boldsymbol{W}_{extant}, \boldsymbol{X}, \boldsymbol{Y})$ using the multiple imputation with chained equations (MICE) algorithm (@MICE) with predictive mean matching.  The imputation algorithm is run to obtain a total of $M = 100$ completed datasets.

## Completed Data Model 
For each of the $M = 100$ imputed datasets, we fit an OU model for different phenotypes of interest.  We choose one of the columns of $X$ to be the target phenotype and our analysis is repeated for all phenotypes of interest.  

Let $W_{ti}$, $\boldsymbol{X}_{ti}$, and $\boldsymbol{Y}_{ti}$ be the imputed gender, $K_{cont} \times 1$ vector of continuous phenotypes, and $K_{disc} \times 1$ vector of discrete phenotypes, respectively, for the $i$-th observed fossil in year $t$ for $t = 1, \ldots, 18$ and  $i = 1\ldots,n_{t}$.  In addition,

\begin{align}
X_{ti} \iid \left\{\begin{array}{ll} \mathcal{N}(\theta_f + u_{ft},\sigma^2), & W_{ti} = \text{Female} \\ \mathcal{N}(\theta_m + u_{mt},\sigma^2), & W_{ti} = \text{Male} \end{array}\right.
\label{eq:x}
\end{align}

Look at \ref{eq:x}

For $g \in \{f,m\}$, $\theta_g$, is the defined as the overall mean of the phenotype of interest for each gender, and $u_{gt}$ are the gender specific random effects, measuring the difference between the gender and time-specific mean and the overall gender-specific mean, which we fit to an autoregressive process of lag 1, which is the discretization of an OU process.  For $t = 2,\ldots,T$ and $g \in \{f,m\}$, the AR1 model for is defined as

\begin{align}
u_{g,t} \iid \mathcal{N}(\kappa_g u_{g,t-1} , \tau^2).
\label{eq:ar1}
\end{align}

$\kappa_g$ represents the gender-specific correlation between the previous and current time periods' random effects.  In addition, $\text{cor}(u_{g,t},u_{g,t+h}) = (\kappa_g)^h$ for $h \in \mathbb{N}$.

We also set

\begin{align}
u_{g,1} \iid \mathcal{N}\left(0,\frac{\tau^2}{1-\kappa_g^2}\right).
\label{eq:u1}
\end{align}

This model choice is to make the distribution of the random effects stationary, i.e. $p(\mu_{g,s}) = p(\mu_{g,t})$ for $s,t \in \{1,\dots,T\}$.

Priors: 

\begin{align}
\sigma & \sim \mathcal{N}(0,100)I_{\{\sigma > 0\}} \nonumber \\
\tau & \sim \mathcal{N}(0,100)I_{\{\tau > 0\}} \nonumber \\
\kappa & \iid \mathcal{N}(0.5,1)I_{\{-1 < \kappa_g < 1\}} \nonumber \\
\theta_g & \iid \mathcal{N}(54,400)I_{\{\theta_g > 0\}}
\label{eq:priors}
\end{align}


All models were built using @R2022language

@Cornault2022 Bayesian OU model.  

Bayesian Analysis after multiple imputation @ZhouReiter2009: They recommend using a large number of imputations.  5 or 10 is too small.  We are using M = 100.  


# Results {#sec:results}

# Future work and conclusions {#sec:conclusions}


# Acknowledgements {-}


Stickle!

# Supplementary Material {-}

All code for reproducing the analyses in this paper is publicly available at https://github.com/Akhil-Ghosh/SticklebackProject

# References
